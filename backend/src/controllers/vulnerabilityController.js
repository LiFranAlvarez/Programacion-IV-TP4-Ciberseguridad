const { spawn } = require('child_process');

const ping = (req, res) => {
  const { host } = req.body;

  // ValidaciÃ³n estricta de host
  const ipRegex = /^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/;
  const hostnameRegex = /^[a-zA-Z0-9.-]+$/;

  if (!host || !(ipRegex.test(host) || hostnameRegex.test(host))) {
    return res.status(400).json({ error: 'Invalid host' });
  }

  // Lista hosts permitidos
  const allowedHosts = ['8.8.8.8', '1.1.1.1', 'google.com'];
  if (!allowedHosts.includes(host)) {
    return res.status(400).json({ error: 'Host not allowed' });
  }

  // Ejecutar comando de forma segura (sin shell)
  const pingProcess = spawn('ping', ['-c', '1', host]);

  let output = '';
  let errorOutput = '';

  pingProcess.stdout.on('data', (data) => {
    output += data.toString();
  });

  pingProcess.stderr.on('data', (data) => {
    errorOutput += data.toString();
  });

  pingProcess.on('close', (code) => {
    // Si hubo error del sistema no revelar detalles
    if (code !== 0) {
      return res.status(400).json({
        error: 'Ping failed'
      });
    }

    // No permitir caracteres especiales
    if (/[;&|`$]/.test(output)) {
      return res.status(400).json({
        error: 'Invalid output detected'
      });
    }

    return res.json({ output });
  });
};



const transfer = (req, res) => {};
const readFile = (req, res) => {};

module.exports = {
  ping,
  transfer,
  readFile
};
